#!/usr/bin/env bash
# vim: set filetype=bash:

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSHOP_ID=221100

declare -A SERVER_TYPES
SERVER_TYPES[stable]="223350"
SERVER_TYPES[experimental]="1042420"

STEAMCMD_CMD=""
SYSTEMD_FLAG=false

declare -A CHECKLIST
CHECKLIST=(
    [requirements]="0"
    [directories]="0"
    [server]="0"
    [config]="0"
    [permissions]="0"
    [systemd]="0"
)



TEMPLATE_SYSTEMD_SERVICE="""
[Unit]
Description=DayZ Server
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$PROJECT_DIR
ExecStart=$PROJECT_DIR/cmd/server start
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
"""

TEMPLATE_SERVER_USAGE="""
Usage: $0 [OPTIONS]

Options:
    --stable            Install stable DayZ server (default)
    --experimental      Install experimental DayZ server
    --systemd           Create systemd service for auto-start
    --help              Show this help message

Examples:
    $0
    $0 --experimental
    $0 --systemd
"""

function print_usage() {
    echo "$TEMPLATE_SERVER_USAGE"
}

function show_checklist() {
    local title

    title="$1"
    echo ""
    echo "========================================"
    echo "$title"
    echo "========================================"
    echo ""
    echo "Installation Checklist:"
    echo "  [$([ ${CHECKLIST[requirements]} -eq 1 ] && echo 'x' || echo ' ')] Check system requirements"
    echo "  [$([ ${CHECKLIST[directories]} -eq 1 ] && echo 'x' || echo ' ')] Create directory structure"
    echo "  [$([ ${CHECKLIST[server]} -eq 1 ] && echo 'x' || echo ' ')] Download DayZ server files"
    echo "  [$([ ${CHECKLIST[config]} -eq 1 ] && echo 'x' || echo ' ')] Setup configuration files"
    echo "  [$([ ${CHECKLIST[permissions]} -eq 1 ] && echo 'x' || echo ' ')] Set file permissions"
    if [ "$SYSTEMD_FLAG" = true ]; then
        echo "  [$([ ${CHECKLIST[systemd]} -eq 1 ] && echo 'x' || echo ' ')] Create systemd service"
    fi
    echo ""
}

function mark_complete() {
    CHECKLIST[$1]="1"
    show_checklist "Installation Progress"
}

function get_steamcmd() {
    if command -v steamcmd &> /dev/null; then
        STEAMCMD_CMD="steamcmd"
        return 0
    fi

    if [ -f "$HOME/.local/share/steamcmd/steamcmd.sh" ]; then
        STEAMCMD_CMD="$HOME/.local/share/steamcmd/steamcmd.sh"
        return 0
    fi

    if [ -f "$HOME/.steam/steamcmd/steamcmd.sh" ]; then
        STEAMCMD_CMD="$HOME/.steam/steamcmd/steamcmd.sh"
        return 0
    fi

    return 1
}

function check_requirements() {
    echo "[*] Checking system requirements..."

    local missing_tools=0

    for tool in curl tar; do
        if ! command -v "$tool" &> /dev/null; then
            echo "[!] Missing: $tool"
            missing_tools=1
        fi
    done

    if [ $missing_tools -eq 1 ]; then
        echo "[!] Installing missing tools..."
        sudo apt-get update
        sudo apt-get install -y curl tar
    fi

    if ! get_steamcmd; then
        echo "[*] SteamCMD not found. Installing..."
        install_steamcmd
        if ! get_steamcmd; then
            echo "[!] Failed to install SteamCMD"
            exit 1
        fi
    else
        echo "[+] SteamCMD found"
    fi

    mark_complete "requirements"
}

function install_steamcmd() {
    local steamcmd_dir="$HOME/.local/share/steamcmd"
    mkdir -p "$steamcmd_dir"

    if ! curl -sqL "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz" | tar zxvf - -C "$steamcmd_dir" 2>&1; then
        echo "[!] Failed to download/extract SteamCMD"
        exit 1
    fi

    chmod +x "$steamcmd_dir/steamcmd.sh"

    if ! [ -f "$steamcmd_dir/steamcmd.sh" ]; then
        echo "[!] SteamCMD installation failed"
        exit 1
    fi

    mkdir -p "$HOME/.local/bin"
    ln -sf "$steamcmd_dir/steamcmd.sh" "$HOME/.local/bin/steamcmd"

    echo "[+] SteamCMD installed"
}

function setup_directories() {
    echo "[*] Creating directory structure..."

    mkdir -p "$PROJECT_DIR"/{mods,keys,logs,data,backups,mpmissions}
    mkdir -p "$PROJECT_DIR/server"/{battleye,profiles,steamapps/workshop/content/$WORKSHOP_ID}

    mark_complete "directories"
}

function run_steamcmd() {
    if [ -z "$STEAMCMD_CMD" ]; then
        echo "[!] SteamCMD not available"
        return 1
    fi

    "$STEAMCMD_CMD" "$@"
    return $?
}

function install_server_files() {
    local server_mode="${1:-stable}"
    local server_id="${SERVER_TYPES[$server_mode]}"

    echo "[*] Downloading DayZ server files ($server_mode)..."
    echo "    Server App ID: $server_id"
    echo ""
    echo "This requires a Steam account with DayZ server license."
    echo ""

    read -p "Enter Steam username: " steam_user
    read -sp "Enter Steam password: " steam_pass
    echo ""

    if [ -z "$steam_user" ] || [ -z "$steam_pass" ]; then
        echo "[!] Steam credentials are required"
        return 1
    fi

    echo "[*] Downloading server files via SteamCMD..."
    echo "[*] This may take 30-60 minutes (downloading ~50GB)..."
    echo ""

    if run_steamcmd \
        +@NoPromptForPassword 1 \
        +login "$steam_user" "$steam_pass" \
        +force_install_dir "$PROJECT_DIR/server" \
        +app_update "$server_id" validate \
        +quit; then

        mark_complete "server"
        return 0
    else
        echo "[!] Failed to download server files"
        echo "[!] Possible reasons:"
        echo "    - Invalid Steam credentials"
        echo "    - Steam account doesn't have DayZ server license"
        echo "    - Network connectivity issue"
        echo "    - SteamCMD encountered an error"
        return 1
    fi
}

function install_mods() {
    echo "[*] Mods are managed via ./cmd/mods script"
    echo "[*] After server installation, use:"
    echo "    ./cmd/mods enable <MOD_ID> <MOD_NAME>"
    echo "    ./cmd/mods install"
    mark_complete "mods"
}





function setup_configuration() {
    echo "[*] Setting up configuration files..."

    if [ ! -f "$PROJECT_DIR/server/serverDZ.cfg" ]; then
        cp "$PROJECT_DIR/config/serverDZ.cfg" "$PROJECT_DIR/server/" 2>/dev/null || echo "[!] serverDZ.cfg not found"
    fi

    mkdir -p "$PROJECT_DIR/server/mpmissions"

    mark_complete "config"
}

function setup_permissions() {
    echo "[*] Setting up file permissions..."

    chmod +x "$SCRIPT_DIR"/*
    chmod -R 755 "$PROJECT_DIR/server" 2>/dev/null || true

    mark_complete "permissions"
}

function create_systemd_service() {
    echo "[*] Creating systemd service..."
    echo "$TEMPLATE_SYSTEMD_SERVICE" | sudo tee /etc/systemd/system/dayz-server.service
    sudo systemctl daemon-reload
    mark_complete "systemd"
}

function main() {
    local server_mode="stable"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --stable)
                server_mode="stable"
                shift
                ;;
            --experimental)
                server_mode="experimental"
                shift
                ;;
            --systemd)
                SYSTEMD_FLAG=true
                shift
                ;;
            --help)
                print_usage
                exit 0
                ;;
            *)
                echo "[!] Unknown option: $1"
                print_usage
                exit 1
                ;;
        esac
    done

    show_checklist "DayZ Server Installation"

    check_requirements || exit 1
    setup_directories || exit 1

    if ! install_server_files "$server_mode"; then
        echo "[!] Server installation failed"
        exit 1
    fi

    setup_configuration || true
    setup_permissions || true

    echo ""
    show_checklist "Installation Complete!"

    if [ -f "$PROJECT_DIR/server/DayZServer" ]; then
        echo "[+] DayZ Server successfully installed at:"
        echo "    $PROJECT_DIR/server/DayZServer"
        echo ""
    else
        echo "[!] Warning: DayZServer executable not found"
        echo "[!] Check the installation logs above for errors"
        echo ""
    fi

    echo "Next steps:"
    echo "1. Review server config: $PROJECT_DIR/config/serverDZ.cfg"
    echo "2. Enable mods: ./cmd/mods enable <MOD_ID> <MOD_NAME>"
    echo "3. Download mods: ./cmd/mods install"
    echo "4. Start the server: ./cmd/server start"
    echo ""
    echo "Useful commands:"
    echo "    ./cmd/mods help         - Show mod management commands"
    echo "    ./cmd/mods status       - List configured mods"
    echo "    ./cmd/server status     - Show server status"
    echo "    tail -f logs/server.log - Follow server logs"
    echo "    ./cmd/server stop       - Stop the server"
    echo ""

    if [ "$SYSTEMD_FLAG" = true ]; then
        create_systemd_service || true
    else
        read -p "Create systemd service for auto-start? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            create_systemd_service || true
        fi
    fi
}


main "$@"
exit $?
