#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
AVAHI_SERVICE_FILE="/etc/avahi/services/dayz-server.service"
AVAHI_SOURCE="$PROJECT_DIR/config/dayz-server.service"

echo "DayZ Server LAN Announcement Setup"
echo "===================================="
echo ""

if ! command -v avahi-daemon &> /dev/null; then
    echo "[!] Avahi is not installed"
    echo "    Install with: sudo apt install avahi-daemon"
    exit 1
fi

if ! systemctl is-active --quiet avahi-daemon; then
    echo "[!] Avahi daemon is not running"
    echo "    Start with: sudo systemctl start avahi-daemon"
    exit 1
fi

if [ ! -f "$AVAHI_SOURCE" ]; then
    echo "[!] Service file not found: $AVAHI_SOURCE"
    exit 1
fi

echo "[*] Installing Avahi service file..."
echo "    (requires sudo, you will be prompted for password)"
echo ""

if sudo cp "$AVAHI_SOURCE" "$AVAHI_SERVICE_FILE" && sudo systemctl reload avahi-daemon; then
    echo "[+] Done!"
    echo ""
    echo "Your server should now be discoverable on the LAN via mDNS"
    echo ""
    echo "To remove, run:"
    echo "    sudo rm /etc/avahi/services/dayz-server.service"
    echo "    sudo systemctl reload avahi-daemon"
else
    echo "[!] Setup failed - try running with sudo:"
    echo "    sudo $0"
    exit 1
fi
